{% extends "header.html" %}
{% load static %}
{% load i18n %}

{% block title %}My Journals{% endblock %}

<head>
    {% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Forum&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{% static 'bullet_journal/css/styles.css' %}">
    {% endblock %}

</head>

{% block contenido %}
{% if user.is_authenticated %}
{% else %}
<p>You are not logged in</p>
<a href="{% url 'login' %}">Log In</a>
{% endif %}

<body>
    <div class="journal">
            
        <form method="get" class="p-3">
            <div class="row g-3 align-items-end">
                <!---div class="col-md-3">
                    <label for="date" class="form-label">Fecha:</label>
                    <input type="date" id="date" name="date" value="{{ request.GET.date }}" class="form-control">
                </div--->

                <div class="col-md-3">
                    <label for="sleep_hours" class="form-label">Horas de sueño:</label>
                    <select id="sleep_hours" name="sleep_hours" class="form-select">
                        <option value="">Todas</option>
                        {% for h in sleep_hours_range %}
                            <option value="{{ h }}" {% if request.GET.sleep_hours == h|stringformat:"s" %}selected{% endif %}>{{ h }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="mood" class="form-label">Estado de ánimo:</label>
                    <select id="mood" name="mood" class="form-select">
                        <option value="">Todos</option>
                        {% for mood in moods_disponibles %}
                            <option value="{{ mood }}" {% if mood == request.GET.mood %}selected{% endif %}>{{ mood }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="exercise" class="form-label">Hice ejercicio:</label>
                    <select id="exercise" name="exercise" class="form-select">
                        <option value="">Todos</option>
                        <option value="true" {% if request.GET.exercise == "true" %}selected{% endif %}>Sí</option>
                        <option value="false" {% if request.GET.exercise == "false" %}selected{% endif %}>No</option>
                    </select>
                </div>

                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                    <a href="{% url 'journal_list' %}" class="btn btn-secondary">Quitar filtros</a>
                </div>
            </div>
        </form>
            
        <!---div class="journal-list">
            {% for journal in journals|dictsortreversed:"date" %} 
                <div class="journal-item">

                    <button class="open-popup-btn btn btn-primary" data-journal-pk="{{ journal.pk }}">
                        {% language 'es' %}
                            {{ journal.date|date:"l"|title }}
                            {{ journal.date|date:"j \d\e F \d\e Y" }}
                        {% endlanguage %}
                    </button>

                    <div id="popup-container-{{ journal.pk }}" class="popup-container">
                        <div class="popup-content">
                            <span class="close-btn" data-journal-pk="{{ journal.pk }}">&times;</span>
                            
                            {% language 'es' %}
                                <p><strong>Día:</strong> {{ journal.date|date:"l"|title }} {{ journal.date|date:"j \d\e F \d\e Y" }}</p>
                            {% endlanguage %}

                            <p><strong>Estado de ánimo:</strong> {{ journal.mood }}</p>
                            <p><strong>Horas de sueño:</strong> {{ journal.sleep_hours }}</p>
                            <p><strong>Vasos de agua:</strong> {{ journal.water_glasses }}</p>
                            <p><strong>Ejercicio:</strong> {% if journal.exercise %}Sí{% else %}No{% endif %}</p>

                            {% if journal.image %}
                                <p><strong>Imagen:</strong></p>
                                <img src="{{ journal.image.url }}" alt="Imagen del journal" style="max-width: 90px;">
                            {% endif %}

                            <p></p>
                            <a href="{% url 'journal_edit' journal.pk %}" style="color: #ff6a19;">Editar Journal</a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p>No hay journals.</p>
            {% endfor %}
        </div--->

        <!-- Intento de hacer el libro que NO FUNCIONA -->

        <!---div class="book-container">
            <div class="page left-page">
                {% for day in week_days|slice:":4" %}
                <div class="day-cell1">
                    {% if day.journal %}
                    <button class="open-popup-btn btn btn-primary" data-journal-pk="{{ day.journal.pk }}">
                        {% language 'es' %}
                        {{ day.date|date:"l"|title }}
                        {{ day.date|date:"j \d\e F" }}
                        {% endlanguage %}
                    </button>

                    <div id="popup-container-{{ day.journal.pk }}" class="popup-container">
                        <div class="popup-content">
                        <span class="close-btn" data-journal-pk="{{ day.journal.pk }}">&times;</span>
                        {% language 'es' %}
                            <p><strong>Día:</strong> {{ day.journal.date|date:"l"|title }} {{ day.journal.date|date:"j \d\e F \d\e Y" }}</p>
                        {% endlanguage %}
                        <p><strong>Estado de ánimo:</strong> {{ day.journal.mood }}</p>
                        <p><strong>Horas de sueño:</strong> {{ day.journal.sleep_hours }}</p>
                        <p><strong>Vasos de agua:</strong> {{ day.journal.water_glasses }}</p>
                        <p><strong>Ejercicio:</strong> {% if day.journal.exercise %}Sí{% else %}No{% endif %}</p>
                        {% if day.journal.image %}
                            <p><strong>Imagen:</strong></p>
                            <img src="{{ day.journal.image.url }}" alt="Imagen del journal" style="max-width: 90px;">
                        {% endif %}
                        <a href="{% url 'journal_edit' day.journal.pk %}" style="color: #ff6a19;">Editar Journal</a>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-journal">
                        {% language 'es' %}
                        {{ day.date|date:"l"|title }}
                        {{ day.date|date:"j \d\e F" }}
                        {% endlanguage %}
                        <br><small>Sin registro</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="page right-page">
                {% for day in week_days|slice:"4:" %}
                <div class="day-cell1">
                    {% if day.journal %}
                    <button class="open-popup-btn btn btn-primary" data-journal-pk="{{ day.journal.pk }}">
                        {% language 'es' %}
                        {{ day.date|date:"l"|title }}
                        {{ day.date|date:"j \d\e F" }}
                        {% endlanguage %}
                    </button>
                    <div id="popup-container-{{ day.journal.pk }}" class="popup-container">
                        <div class="popup-content">
                        <span class="close-btn" data-journal-pk="{{ day.journal.pk }}">&times;</span>
                        {% language 'es' %}
                            <p><strong>Día:</strong> {{ day.journal.date|date:"l"|title }} {{ day.journal.date|date:"j \d\e F \d\e Y" }}</p>
                        {% endlanguage %}
                        <p><strong>Estado de ánimo:</strong> {{ day.journal.mood }}</p>
                        <p><strong>Horas de sueño:</strong> {{ day.journal.sleep_hours }}</p>
                        <p><strong>Vasos de agua:</strong> {{ day.journal.water_glasses }}</p>
                        <p><strong>Ejercicio:</strong> {% if day.journal.exercise %}Sí{% else %}No{% endif %}</p>
                        {% if day.journal.image %}
                            <p><strong>Imagen:</strong></p>
                            <img src="{{ day.journal.image.url }}" alt="Imagen del journal" style="max-width: 90px;">
                        {% endif %}
                        <a href="{% url 'journal_edit' day.journal.pk %}" style="color: #ff6a19;">Editar Journal</a>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-journal">
                        {% language 'es' %}
                        {{ day.date|date:"l"|title }}
                        {{ day.date|date:"j \d\e F" }}
                        {% endlanguage %}
                        <br><small>Sin registro</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            </div--->

        
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month" class="nav-btn">←</button>
                <h2 id="current-month-year"></h2>
                <button id="next-month" class="nav-btn">→</button>
            </div>
            <div class="weekdays">
                <div>Dom</div>
                <div>Lun</div>
                <div>Mar</div>
                <div>Mié</div>
                <div>Jue</div>
                <div>Vie</div>
                <div>Sáb</div>
            </div>
            <div id="calendar-body" class="calendar-body">
        </div>
        </div>

                <div id="journal-data" style="display:none;">
                    {% for journal in journals %}
                        <div class="journal-entry" data-date="{{ journal.date|date:'Y-m-d' }}" data-pk="{{ journal.pk }}">
                            {% language 'es' %}
                                <p><strong>Día:</strong> {{ journal.date|date:"l"|title }} {{ journal.date|date:"j \d\e F \d\e Y" }}</p>
                            {% endlanguage %}

                            <p><strong>Estado de ánimo:</strong> {{ journal.mood }}</p>
                            <p><strong>Horas de sueño:</strong> {{ journal.sleep_hours }}</p>
                            <p><strong>Vasos de agua:</strong> {{ journal.water_glasses }}</p>
                            <p><strong>Ejercicio:</strong> {% if journal.exercise %}Sí{% else %}No{% endif %}</p>

                            {% if journal.image %}
                                <p><strong>Imagen:</strong></p>
                                <img src="{{ journal.image.url }}" alt="Imagen del journal" style="max-width: 90px;">
                            {% endif %}

                            <p></p>
                            <a href="{% url 'journal_edit' journal.pk %}" style="color: #ff6a19;">Editar Journal</a>
                        </div>
                    {% endfor %}
                </div>


        <p> </p>
        <p> </p>
        {% if not existe_hoy %}
            <div class="journal_create">
                <a href="{% url 'journal_create' %}">¡Registrar mi día!</a>
            </div>
        {% endif %}

        <p></p>
    </div>

<!--script>
    document.addEventListener('DOMContentLoaded', () => {
    // Escucha clics en cualquier botón con la clase 'open-popup-btn'
    document.querySelectorAll('.open-popup-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const journalPk = event.target.dataset.journalPk;
            const popup = document.getElementById(`popup-container-${journalPk}`);
            if (popup) {
                popup.style.display = 'flex';
            }
        });
    });

    // Escucha clics en cualquier botón de cierre
    document.querySelectorAll('.close-btn').forEach(closeBtn => {
        closeBtn.addEventListener('click', (event) => {
            const journalPk = event.target.dataset.journalPk;
            const popup = document.getElementById(`popup-container-${journalPk}`);
            if (popup) {
                popup.style.display = 'none';
            }
        });
    });

    // Escucha clics fuera de la ventana emergente para cerrar
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('popup-container')) {
            event.target.style.display = 'none';
        }
    });

    document.querySelectorAll('.go-to-detail-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const url = event.target.dataset.journalUrl;
            if (url) {
                window.location.href = url; // Redirige al usuario a la URL
            }
        });
    });
});

</script--->

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const calendarBody = document.getElementById('calendar-body');
    const monthYearDisplay = document.getElementById('current-month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const journalDataContainer = document.getElementById('journal-data');

    let currentDate = new Date();
    let journals = [];

    document.querySelectorAll('.journal-entry').forEach(entry => {
        journals.push({
            date: entry.dataset.date,
            pk: entry.dataset.pk,
            content: entry.innerHTML
        });
    });

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthName = currentDate.toLocaleDateString('es-ES', { month: 'long' });
        const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        monthYearDisplay.textContent = `${capitalizedMonth} ${year}`;

        calendarBody.innerHTML = '';
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            calendarBody.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('day-cell');

            const dayNumberSpan = document.createElement('span');
            dayNumberSpan.classList.add('day-number');
            dayNumberSpan.textContent = day;
            dayCell.appendChild(dayNumberSpan);

            const formattedDate = new Date(year, month, day).toISOString().slice(0, 10);
            const journal = journals.find(j => j.date === formattedDate);

            if (journal) {
                dayCell.classList.add('has-journal');
                const journalIndicator = document.createElement('span');
                journalIndicator.classList.add('journal-indicator');
                journalIndicator.textContent = '✓'; // ← tilde
                dayCell.appendChild(journalIndicator);

                dayCell.addEventListener('click', () => showPopup(journal));
            }

            calendarBody.appendChild(dayCell);
        }
    }

    function showPopup(journal) {
        const existingPopup = document.querySelector('.popup-container');
        if (existingPopup) {
            existingPopup.remove();
        }

        const popupContainer = document.createElement('div');
        popupContainer.classList.add('popup-container');

        const popupContent = document.createElement('div');
        popupContent.classList.add('popup-content');
        popupContent.innerHTML = `
            <span class="close-btn">&times;</span>
            ${journal.content}
        `;

        const closeBtn = popupContent.querySelector('.close-btn');
        closeBtn.addEventListener('click', () => popupContainer.style.display = 'none');
        
        popupContainer.appendChild(popupContent);
        document.body.appendChild(popupContainer);

        popupContainer.style.display = 'flex';
        
        popupContainer.addEventListener('click', (event) => {
            if (event.target === popupContainer) {
                popupContainer.style.display = 'none';
            }
        });
    }

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
</script>

</body>
{% endblock %}

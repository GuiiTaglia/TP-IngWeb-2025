{% extends "header.html" %}
{% load static %}

{% block title %}My Calendar{% endblock %}

<head>
    {% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Forum&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{% static 'bullet_journal/css/styles.css' %}">
    {% endblock %}

</head>

{% block contenido %}
{% if user.is_authenticated %}
{% else %}
<p>You are not logged in</p>
<a href="{% url 'login' %}">Log In</a>
{% endif %}
<body>
    

<div class="calendar-container">
    <div class="calendar-header">
        <button id="prev-month">❮</button>
        <h2 id="current-month-year"></h2>
        <button id="next-month">❯</button>
    </div>
    <div class="weekdays">
        <div>Dom</div>
        <div>Lun</div>
        <div>Mar</div>
        <div>Mié</div>
        <div>Jue</div>
        <div>Vie</div>
        <div>Sáb</div>
    </div>
    <div id="calendar-body" class="calendar-body">
        </div>
</div>

<div id="journal-data" style="display:none;">
    {% for journal in journals %}
        <div class="journal-entry" data-date="{{ journal.date|date:'Y-m-d' }}" data-pk="{{ journal.pk }}">
            <p><strong>Día:</strong> {{ journal.date }}</p>
            <p><strong>Estado de ánimo:</strong> {{ journal.mood }}</p>
            <p><strong>Horas de sueño:</strong> {{ journal.sleep_hours }}</p>
            <p><strong>Vasos de agua:</strong> {{ journal.water_glasses }}</p>
            <p><strong>Ejercicio:</strong> {% if journal.exercise %}Sí{% else %}No{% endif %}</p>
            <!-- AGREGAR ESTA SECCIÓN DE HÁBITOS: -->
            {% if journal.custom_habits_data %}
                <div class="habits-section">
                    <p><strong>Hábitos Personalizados:</strong></p>
                    {% for habit_key, habit_value in journal.custom_habits_data.items %}
                        {% if habit_value %}
                            {% for habit in user_habits %}
                                {% if habit_key == "habit_"|add:habit.id|stringformat:"s" %}
                                    <p><strong>{{ habit.name }}:</strong> 
                                    {% if habit.type == 'boolean' %}
                                        Sí
                                    {% else %}
                                        {{ habit_value }}{% if habit.unit %} {{ habit.unit }}{% endif %}
                                    {% endif %}
                                    </p>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}           
            
            
            {% if journal.image %}
                <img src="{{ journal.image.url }}" alt="Imagen del journal" style="max-width: 100px;">
            {% endif %}
        </div>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const calendarBody = document.getElementById('calendar-body');
    const monthYearDisplay = document.getElementById('current-month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const journalDataContainer = document.getElementById('journal-data');

    let currentDate = new Date();
    let journals = [];

    // 1. Cargar los datos de los journals desde el HTML oculto
    document.querySelectorAll('.journal-entry').forEach(entry => {
        journals.push({
            date: entry.dataset.date,
            pk: entry.dataset.pk,
            content: entry.innerHTML
        });
    });

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthYearDisplay.textContent = `${currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;

        calendarBody.innerHTML = '';
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Rellenar días vacíos al inicio
        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            calendarBody.appendChild(emptyCell);
        }

        // Crear las celdas de los días
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('day-cell');

            const dayNumberSpan = document.createElement('span');
            dayNumberSpan.classList.add('day-number');
            dayNumberSpan.textContent = day;
            dayCell.appendChild(dayNumberSpan);

            const formattedDate = new Date(year, month, day).toISOString().slice(0, 10);
            const journal = journals.find(j => j.date === formattedDate);

            if (journal) {
                dayCell.classList.add('has-journal');
                const journalIndicator = document.createElement('span');
                journalIndicator.classList.add('journal-indicator');
                dayCell.appendChild(journalIndicator);

                // Agregar el evento de clic para mostrar la pop-up
                dayCell.addEventListener('click', () => showPopup(journal));
            }

            calendarBody.appendChild(dayCell);
        }
    }

    function showPopup(journal) {
        // Elimina cualquier pop-up existente
        const existingPopup = document.querySelector('.popup-container');
        if (existingPopup) {
            existingPopup.remove();
        }

        // Crea el pop-up dinámicamente
        const popupContainer = document.createElement('div');
        popupContainer.classList.add('popup-container');

        const popupContent = document.createElement('div');
        popupContent.classList.add('popup-content');
        popupContent.innerHTML = `
            <span class="close-btn">&times;</span>
            <h3>Detalles del Journal</h3>
            ${journal.content}
        `;

        const closeBtn = popupContent.querySelector('.close-btn');
        closeBtn.addEventListener('click', () => popupContainer.style.display = 'none');
        
        popupContainer.appendChild(popupContent);
        document.body.appendChild(popupContainer);

        popupContainer.style.display = 'flex';
        
        // Cierra el pop-up al hacer clic fuera
        popupContainer.addEventListener('click', (event) => {
            if (event.target === popupContainer) {
                popupContainer.style.display = 'none';
            }
        });
    }

    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
</script>

</body>
{% endblock %}
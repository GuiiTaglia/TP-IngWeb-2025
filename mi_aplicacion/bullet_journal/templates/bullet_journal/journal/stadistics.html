{% extends "header.html" %}
{% load static %}

{% block title %}Your stadistics{% endblock %}

<head>
    {% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Forum&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{% static 'bullet_journal/css/styles.css' %}">
    {% endblock %}
</head>

{% block subtitulo %}
{% if user.is_authenticated %}
{% else %}
<p>You are not logged in</p>
<a href="{% url 'login' %}">Log In</a>
{% endif %}
{% endblock %}

{% block contenido %}
<body>

<div class="container mt-4">
    <h1>Estad√≠sticas de tu Journal</h1>
    

    <!-- ARREGLADO: Estructura del selector de per√≠odos -->
    <div class="period-controls mb-4">
        <div class="row">
            <!-- Controles principales -->
            <div class="col-md-8">
                <div class="btn-group" role="group">
                    <a href="?period=weekly"
                        class="btn-periodo {% if current_period == 'weekly' %}activo{% endif %}">
                        Semanal
                    </a>
                    <a href="?period=monthly"
                        class="btn-periodo {% if current_period == 'monthly' %}activo{% endif %}">
                        Mensual
                    </a>
                    <a href="?period=yearly"
                        class="btn-periodo {% if current_period == 'yearly' %}activo{% endif %}">
                        Anual
                    </a>
                </div>
            </div>
            
            <!-- ARREGLADO: Selector de mes espec√≠fico -->
            <div class="col-md-4">
                <div class="dropdown">
                    <button class="btn btn-outline-info dropdown-toggle {% if current_period == 'specific_month' %}btn-info text-white{% endif %}" 
                            type="button" 
                            id="monthSelector" 
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        
                        {% if current_period == 'specific_month' and period_info.month_name %}
                            {{ period_info.month_name }} {{ period_info.year }}
                        {% else %}
                            Elegir mes espec√≠fico
                        {% endif %}
                    </button>
                    
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="monthSelector" style="max-height: 300px; overflow-y: auto;">
                        {% if months_data %}
                            {% for month_data in months_data %}
                                <li>
                                    <a class="dropdown-item d-flex justify-content-between" 
                                       href="?period=specific_month&year={{ month_data.year }}&month={{ month_data.month }}">
                                        <span>{{ month_data.display }}</span>
                                        <small class="text-muted">{{ month_data.count }} d√≠as</small>
                                    </a>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li><span class="dropdown-item text-muted">No hay datos disponibles</span></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n del per√≠odo actual -->
    {% if journals_count > 0 %}
    <p class="text-muted">
        Mostrando estad√≠sticas de {{ journals_count }} journal(s)
        {% if current_period == 'weekly' %}
            - <strong>√öltimos 7 d√≠as</strong>
        {% elif current_period == 'monthly' %}
            - <strong>√öltimos 30 d√≠as</strong>
        {% elif current_period == 'yearly' %}
            - <strong>Vista anual por meses ({{ current_year }})</strong>
        {% elif current_period == 'specific_month' and period_info.month_name %}
            - <strong>{{ period_info.month_name }} {{ period_info.year }}</strong>
        {% endif %}
    </p>
    {% else %}
    <div class="alert alert-info">
        No tienes journals registrados a√∫n. <a href="{% url 'journal_create' %}">Crear tu primer journal</a>
    </div>
    {% endif %}

    <!-- ARREGLADO: Mostrar gr√°ficas SIEMPRE que haya estad√≠sticas -->
    {% if stats and stats|length > 0 %}
    <div class="row">
        {% for stat in stats %}
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5>
                        {{ stat.field_display }}
                        {% if stat.goal_value %}
                            <small class="text-muted">(Meta: {{ stat.goal_value }}{% if stat.unit %} {{ stat.unit }}{% endif %})</small>
                        {% endif %}
                        
                        {% if current_period == 'yearly' and stat.field_type == 'boolean' %}
                            <br><small class="text-info">% de d√≠as completados por mes</small>
                        {% elif current_period == 'yearly' and stat.field_type == 'number' %}
                            <br><small class="text-info">Promedio mensual</small>
                        {% elif current_period == 'specific_month' %}
                            <br><small class="text-info">Datos diarios del mes</small>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body" style="height: 400px;">
                    <canvas id="chart-{{ stat.field }}"></canvas>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <h4>üìä No hay datos suficientes</h4>
            <p>
                {% if current_period == 'weekly' %}
                    No tienes entradas de journal en los √∫ltimos 7 d√≠as.
                {% elif current_period == 'monthly' %}
                    No tienes entradas de journal en los √∫ltimos 30 d√≠as.
                {% elif current_period == 'yearly' %}
                    No tienes entradas de journal en este a√±o ({{ current_year }}).
                {% elif current_period == 'specific_month' %}
                    No tienes entradas en el mes seleccionado.
                {% endif %}
            </p>
            <a href="{% url 'journal_create' %}" class="btn btn-warning">
                ‚úçÔ∏è Crear mi primera entrada
            </a>
        </div>
    </div>
    {% endif %}

</div>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    console.log("INICIANDO SCRIPT DE GR√ÅFICOS");

    let statsData;
    try {
        statsData = JSON.parse('{{ stats_json|escapejs }}');
        console.log("DEBUG: Stats recibidas:", statsData);
        console.log("DEBUG: Per√≠odo actual:", '{{ current_period }}');
    } catch (e) {
        console.error("ERROR: No se pudo parsear stats_json:", e);
        statsData = [];
    }

    if (statsData && statsData.length > 0) {
        statsData.forEach(stat => {
            console.log(`DEBUG: Procesando ${stat.field_display}:`, stat);

            const canvas = document.getElementById(`chart-${stat.field}`);
            if (!canvas) {
                console.error(`ERROR: No se encontr√≥ canvas con ID chart-${stat.field}`);
                return;
            }

            const ctx = canvas.getContext('2d');
            const labels = stat.data ? stat.data.labels : [];
            let values = stat.data ? stat.data.values : [];

            // CONFIGURACI√ìN ESPECIAL PARA ESTADO DE √ÅNIMO (GR√ÅFICO DE TORTA)
            if (stat.field === 'mood') {
                console.log("üé≠ Procesando gr√°fico de emociones:", values);

                const moodCounts = {};
                const moodNormalized = {};

                values.forEach(mood => {
                    if (mood && mood !== null && mood.toString().trim() !== '') {
                        const normalizedMood = mood.toString().toLowerCase().trim();
                        const originalMood = mood.toString().trim();

                        moodCounts[normalizedMood] = (moodCounts[normalizedMood] || 0) + 1;

                        if (!moodNormalized[normalizedMood] ||
                            originalMood.length > moodNormalized[normalizedMood].length) {
                            moodNormalized[normalizedMood] = originalMood;
                        }
                    }
                });

                // ARREGLADO: Verificar si hay datos antes de crear el gr√°fico
                if (Object.keys(moodCounts).length === 0) {
                    console.log("‚ö†Ô∏è No hay datos de emociones para mostrar");
                    // Mostrar mensaje en el canvas
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'center';
                    ctx.fillText('No hay datos de emociones', canvas.width/2, canvas.height/2);
                    return;
                }

                const moodLabels = Object.keys(moodCounts).map(normalized => moodNormalized[normalized]);
                const moodData = Object.values(moodCounts);

                function generateColor(normalizedMood, index) {
                    const predefinedColors = {
                        'feliz': '#f39c12', 'muy feliz': '#f1c40f', 'contento': '#e67e22', 
                        'alegre': '#ff9f43', 'euf√≥rico': '#feca57', 'triste': '#3498db',       
                        'muy triste': '#2980b9', 'deprimido': '#34495e', 'melanc√≥lico': '#5dade2',  
                        'enojado': '#e74c3c', 'furioso': '#c0392b', 'molesto': '#e55039',      
                        'irritado': '#ff6b6b', 'ansioso': '#9b59b6', 'nervioso': '#8e44ad',     
                        'estresado': '#a55eea', 'preocupado': '#74b9ff', 'relajado': '#27ae60',     
                        'calmado': '#2ed573', 'tranquilo': '#1dd1a1', 'sereno': '#55efc4',       
                        'neutral': '#95a5a6', 'normal': '#bdc3c7', 'bien': '#74b9ff',         
                        'regular': '#a4b0be'
                    };

                    const additionalColors = [
                        '#ff7675', '#fd79a8', '#fdcb6e', '#6c5ce7', '#74b9ff', '#00b894', 
                        '#00cec9', '#e17055', '#81ecec', '#fab1a0', '#a29bfe', '#55a3ff', 
                        '#26de81', '#fc5c65', '#fed330', '#45aaf2', '#4b7bec'
                    ];

                    return predefinedColors[normalizedMood] ||
                        additionalColors[index % additionalColors.length];
                }

                const backgroundColors = Object.keys(moodCounts).map((normalizedMood, index) => {
                    return generateColor(normalizedMood, index);
                });

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: moodLabels,
                        datasets: [{
                            label: 'Estados de √Ånimo',
                            data: moodData,
                            backgroundColor: backgroundColors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { padding: 15, usePointStyle: true, font: { size: 12 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return `${context.label}: ${context.parsed} d√≠a${context.parsed > 1 ? 's' : ''} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

            } else if (stat.field === 'exercise') {
                console.log("üí™ Procesando gr√°fico de ejercicio:", values);

                let exerciseValues, backgroundColors, borderColors;

                // ARREGLADO: Incluir specific_month
                if ('{{ current_period }}' === 'yearly') {
                    exerciseValues = values;
                    backgroundColors = values.map(value => {
                        if (value >= 75) return '#27ae6080';
                        if (value >= 50) return '#f39c1280';
                        if (value >= 25) return '#e67e2280';
                        return '#e74c3c80';
                    });
                    borderColors = backgroundColors.map(color => color.replace('80', ''));
                } else {
                    // Para weekly, monthly, specific_month
                    exerciseValues = values.map(value => {
                        if (value === null || value === undefined) return 0;
                        return value === true ? 1 : -1;
                    });
                    backgroundColors = exerciseValues.map(value => {
                        if (value === 1) return '#27ae6080';
                        if (value === -1) return '#e74c3c80';
                        return '#95a5a680';
                    });
                    borderColors = exerciseValues.map(value => {
                        if (value === 1) return '#27ae60';
                        if (value === -1) return '#e74c3c';
                        return '#95a5a6';
                    });
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: stat.field_display,
                            data: exerciseValues,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: '{{ current_period }}' === 'yearly' ? 0 : -1.5,
                                max: '{{ current_period }}' === 'yearly' ? 100 : 1.5,
                                ticks: {
                                    callback: function (value) {
                                        if ('{{ current_period }}' === 'yearly') {
                                            return value + '%';
                                        } else {
                                            if (value === 1) return '‚úÖ S√ç';
                                            if (value === -1) return '‚ùå NO';
                                            if (value === 0) return '‚Äî';
                                            return '';
                                        }
                                    },
                                    stepSize: '{{ current_period }}' === 'yearly' ? 25 : 1
                                },
                                grid: { display: true, color: '#ecf0f1', lineWidth: 1 }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.parsed.y;
                                        const index = context.dataIndex;

                                        if ('{{ current_period }}' === 'yearly') {
                                            const daysInfo = stat.data.days_info || [];
                                            if (daysInfo[index] && daysInfo[index] !== '') {
                                                return `Ejercicio: ${value}% / (${daysInfo[index]} d√≠as)`;
                                            } else {
                                                return `Ejercicio: ${value}% de d√≠as completados`;
                                            }
                                        } else {
                                            if (value === 1) return 'Ejercicio: ‚úÖ S√ç';
                                            if (value === -1) return 'Ejercicio: ‚ùå NO';
                                            return 'Ejercicio: Sin datos';
                                        }
                                    }
                                }
                            }
                        }
                    },
                    plugins: '{{ current_period }}' !== 'yearly' ? [{
                        id: 'horizontalLine',
                        afterDraw: function (chart) {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            const xAxis = chart.scales.x;
                            const zeroPosition = yAxis.getPixelForValue(0);

                            ctx.save();
                            ctx.strokeStyle = '#2c3e50';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            ctx.moveTo(xAxis.left, zeroPosition);
                            ctx.lineTo(xAxis.right, zeroPosition);
                            ctx.stroke();
                            ctx.restore();
                        }
                    }] : []
                });

            } else if (stat.habit_type) {
                // H√ÅBITOS PERSONALIZADOS - sin cambios en la l√≥gica, solo arreglando specific_month
                console.log(`üéØ Procesando h√°bito: ${stat.field_display}`, stat);
                
                if (stat.habit_type === 'boolean') {
                    let habitValues, backgroundColors, borderColors;

                    if ('{{ current_period }}' === 'yearly') {
                        habitValues = values;
                        backgroundColors = values.map(value => {
                            if (value >= 75) return stat.color + '80';
                            if (value >= 50) return '#f39c12' + '80';
                            if (value >= 25) return '#e67e22' + '80';
                            return '#e74c3c80';
                        });
                        borderColors = backgroundColors.map(color => color.replace('80', ''));
                    } else {
                        // Para weekly, monthly, specific_month
                        habitValues = values.map(value => {
                            if (value === null || value === undefined) return 0;
                            return value === true ? 1 : -1;
                        });
                        backgroundColors = habitValues.map(value => {
                            if (value === 1) return stat.color + '80';
                            if (value === -1) return '#e74c3c80';
                            return '#95a5a680';
                        });
                        borderColors = habitValues.map(value => {
                            if (value === 1) return stat.color;
                            if (value === -1) return '#e74c3c';
                            return '#95a5a6';
                        });
                    }

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: stat.field_display,
                                data: habitValues,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    min: '{{ current_period }}' === 'yearly' ? 0 : -1.5,
                                    max: '{{ current_period }}' === 'yearly' ? 100 : 1.5,
                                    ticks: {
                                        callback: function (value) {
                                            if ('{{ current_period }}' === 'yearly') {
                                                return value + '%';
                                            } else {
                                                if (value === 1) return '‚úÖ S√ç';
                                                if (value === -1) return '‚ùå NO';
                                                if (value === 0) return '‚Äî';
                                                return '';
                                            }
                                        },
                                        stepSize: '{{ current_period }}' === 'yearly' ? 25 : 1
                                    },
                                    grid: { display: true, color: '#ecf0f1', lineWidth: 1 }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const value = context.parsed.y;
                                            const index = context.dataIndex;

                                            if ('{{ current_period }}' === 'yearly') {
                                                const daysInfo = stat.data.days_info || [];
                                                if (daysInfo[index] && daysInfo[index] !== '') {
                                                    return `${stat.field_display}: ${value}% / (${daysInfo[index]} d√≠as)`;
                                                } else {
                                                    return `${stat.field_display}: ${value}% de d√≠as completados`;
                                                }
                                            } else {
                                                if (value === 1) return `${stat.field_display}: ‚úÖ S√ç`;
                                                if (value === -1) return `${stat.field_display}: ‚ùå NO`;
                                                return `${stat.field_display}: Sin datos`;
                                            }
                                        }
                                    
                                        
                                    }
                                }
                            }
                        },
                        plugins: '{{ current_period }}' !== 'yearly' ? [{
                            id: 'horizontalLine',
                            afterDraw: function (chart) {
                                const ctx = chart.ctx;
                                const yAxis = chart.scales.y;
                                const xAxis = chart.scales.x;
                                const zeroPosition = yAxis.getPixelForValue(0);

                                ctx.save();
                                ctx.strokeStyle = '#2c3e50';
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                ctx.moveTo(xAxis.left, zeroPosition);
                                ctx.lineTo(xAxis.right, zeroPosition);
                                ctx.stroke();
                                ctx.restore();
                            }
                        }] : []
                    });

                } else if (stat.habit_type === 'integer') {
                    const datasets = [{
                        label: stat.field_display + (stat.unit ? ` (${stat.unit})` : ''),
                        data: values,
                        borderColor: stat.color,
                        backgroundColor: stat.color + '20',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: stat.color,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }];

                    if (stat.goal_value) {
                        datasets.push({
                            label: 'Meta',
                            data: Array(labels.length).fill(stat.goal_value),
                            borderColor: '#fd7e14',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        });
                    }

                    new Chart(ctx, {
                        type: '{{ current_period }}' === 'yearly' ? 'bar' : 'line',
                        data: { labels: labels, datasets: datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '{{ current_period }}' === 'yearly' ? 'Promedio mensual' : 
                                              ('{{ current_period }}' === 'specific_month' ? 'Valor diario' : 'Valor')
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: '{{ current_period }}' === 'yearly' ? 'Meses' : 
                                              ('{{ current_period }}' === 'specific_month' ? 'D√≠as del mes' : 'Fechas')
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: stat.goal_value ? true : false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            
                                            if (context.dataset.label === 'Meta') {
                                                label += context.parsed.y + (stat.unit ? ` ${stat.unit}` : '');
                                            } else {
                                                const prefix = '{{ current_period }}' === 'yearly' ? 'Promedio: ' : '';
                                                label += prefix + context.parsed.y + (stat.unit ? ` ${stat.unit}` : '');
                                                
                                                if (stat.goal_value && context.parsed.y > 0) {
                                                    const percentage = ((context.parsed.y / stat.goal_value) * 100).toFixed(1);
                                                    label += ` (${percentage}% de la meta)`;
                                                }
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

            } else {
                // OTROS GR√ÅFICOS
                values = values.map(value => {
                    if (value === null || value === undefined) return 0;
                    if (stat.type === 'boolean') return value === true ? 1 : 0;
                    return value;
                });

                new Chart(ctx, {
                    type: '{{ current_period }}' === 'yearly' ? 'bar' : (stat.chart_type === 'bar' ? 'bar' : 'line'),
                    data: {
                        labels: labels,
                        datasets: [{
                            label: stat.field_display,
                            data: values,
                            backgroundColor: stat.color + '80',
                            borderColor: stat.color,
                            borderWidth: 2,
                            fill: stat.chart_type === 'line' ? false : true,
                            tension: stat.chart_type === 'line' ? 0.4 : 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '{{ current_period }}' === 'yearly' ? 'Promedio mensual' : 
                                          ('{{ current_period }}' === 'specific_month' ? 'Valor diario' : 'Valor')
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '{{ current_period }}' === 'yearly' ? 'Meses' : 
                                          ('{{ current_period }}' === 'specific_month' ? 'D√≠as del mes' : 'Fechas')
                                }
                            }
                        },
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';

                                        if (stat.field === 'water_glasses') {
                                            label += context.parsed.y + ' vasos';
                                        } else if (stat.field === 'sleep_hours') {
                                            label += context.parsed.y + ' horas';
                                        } else {
                                            label += context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            console.log(`‚úÖ Gr√°fico creado para ${stat.field_display}`);
        });
    } else {
        console.log("DEBUG: No hay datos para mostrar");
    }

    // Forzar inicializaci√≥n del dropdown si Bootstrap no lo detecta
    document.addEventListener('DOMContentLoaded', function() {
        const dropdownToggle = document.getElementById('monthSelector');
        if (dropdownToggle) {
            console.log('üîç DEBUG: Dropdown encontrado, inicializando...');
            
            // Verificar si Bootstrap est√° cargado
            if (typeof bootstrap !== 'undefined') {
                const dropdown = new bootstrap.Dropdown(dropdownToggle);
                console.log('‚úÖ DEBUG: Dropdown inicializado con Bootstrap');
            } else {
                console.log('‚ùå DEBUG: Bootstrap no est√° disponible');
            }
            
            // Agregar listener manual como backup
            dropdownToggle.addEventListener('click', function(e) {
                e.preventDefault();
                const menu = this.nextElementSibling;
                if (menu) {
                    menu.classList.toggle('show');
                    console.log('üîç DEBUG: Dropdown toggled manualmente');
                }
            });
        } else {
            console.log('‚ùå DEBUG: No se encontr√≥ el dropdown');
        }
    });

</script>
{% endblock contenido %}
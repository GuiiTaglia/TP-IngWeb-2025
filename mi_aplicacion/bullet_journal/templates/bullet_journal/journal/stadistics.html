{% extends "header.html" %}
{% load static %}

{% block title %}Your stadistics{% endblock %}

<head>
    {% block extra_head %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Forum&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{% static 'bullet_journal/css/styles.css' %}">
    {% endblock %}

</head>

{% block subtitulo %}
{% if user.is_authenticated %}
{% else %}
<p>You are not logged in</p>
<a href="{% url 'login' %}">Log In</a>
{% endif %}
{% endblock %}


{% block contenido %}

<body>


<div class="container mt-4">
    <h1>Estad√≠sticas de tu Journal</h1>

    <div class="period-controls mb-4">
        <div class="btn-group" role="group">
            <a href="?period=weekly"
                class="btn-periodo {% if current_period == 'weekly' %}activo{% endif %}">
                Semanal
            </a>
            <a href="?period=monthly"
                class="btn-periodo {% if current_period == 'monthly' %}activo{% endif %}">
                Mensual
            </a>
        </div>
    </div>

    {% if journals_count > 0 %}
    <p class="text-muted">Mostrando estad√≠sticas de {{ journals_count }} journal(s)</p>
    {% else %}
    <div class="alert alert-info">
        No tienes journals registrados a√∫n. <a href="{% url 'journal_create' %}">Crear tu primer journal</a>
    </div>
    {% endif %}

    <!-- DEBUG del Template -->
    <!--<div class="alert alert-warning">
        <h4>DEBUG del Template:</h4>
        <p><strong>stats:</strong> {{ stats }}</p>
        <p><strong>stats|length:</strong> {{ stats|length }}</p>
        <p><strong>stats_json:</strong> {{ stats_json }}</p>
    </div>-->

    <!-- Solo UN loop aqu√≠ -->
    <div class="row">
        {% for stat in stats %}
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5>
                        {{ stat.field_display }}
                        {% if stat.goal_value %}
                            <small class="text-muted">(Meta: {{ stat.goal_value }}{% if stat.unit %} {{ stat.unit }}{% endif %})</small>
                        {% endif %}                        
                    
                    </h5>
                </div>
                <div class="card-body" style="height: 400px;">
                    <canvas id="chart-{{ stat.field }}"></canvas>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                No hay suficientes datos para mostrar estad√≠sticas. ¬°Comienza a registrar tu progreso diario!
            </div>
        </div>
        {% endfor %}
    </div>

</div>
</body>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    console.log("INICIANDO SCRIPT DE GR√ÅFICOS");

    let statsData;
    try {
        statsData = JSON.parse('{{ stats_json|escapejs }}');
        console.log("DEBUG: Stats recibidas:", statsData);
    } catch (e) {
        console.error("ERROR: No se pudo parsear stats_json:", e);
        statsData = [];
    }

    if (statsData && statsData.length > 0) {
        statsData.forEach(stat => {
            console.log(`DEBUG: Procesando ${stat.field_display}:`, stat);

            const canvas = document.getElementById(`chart-${stat.field}`);
            if (!canvas) {
                console.error(`ERROR: No se encontr√≥ canvas con ID chart-${stat.field}`);
                return;
            }

            const ctx = canvas.getContext('2d');
            const labels = stat.data ? stat.data.labels : [];
            let values = stat.data ? stat.data.values : [];

            // CONFIGURACI√ìN ESPECIAL PARA ESTADO DE √ÅNIMO (GR√ÅFICO DE TORTA)
            if (stat.field === 'mood') {
                console.log(" Procesando gr√°fico de emociones:", values);

                // Normalizar y contar emociones (case insensitive)
                const moodCounts = {};
                const moodNormalized = {}; // Para guardar la versi√≥n original m√°s frecuente

                values.forEach(mood => {
                    if (mood && mood !== null && mood.toString().trim() !== '') {
                        const normalizedMood = mood.toString().toLowerCase().trim();
                        const originalMood = mood.toString().trim();

                        // Contar
                        moodCounts[normalizedMood] = (moodCounts[normalizedMood] || 0) + 1;

                        // Guardar la versi√≥n original (la primera vez o la m√°s frecuente)
                        if (!moodNormalized[normalizedMood] ||
                            originalMood.length > moodNormalized[normalizedMood].length) {
                            moodNormalized[normalizedMood] = originalMood;
                        }
                    }
                });
                console.log("DEBUG: Conteo normalizado de emociones:", moodCounts);
                console.log("DEBUG: Versiones originales:", moodNormalized);

                // Preparar datos para el gr√°fico
                const moodLabels = Object.keys(moodCounts).map(normalized => moodNormalized[normalized]);
                const moodData = Object.values(moodCounts);

                //  GENERADOR DE COLORES AUTOM√ÅTICO
                function generateColor(normalizedMood, index) {
                    // Colores predefinidos para emociones comunes
                    const predefinedColors = {
                        'feliz': '#f39c12',        // Naranja
                        'muy feliz': '#f1c40f',    // Amarillo
                        'contento': '#e67e22',     // Naranja oscuro
                        'alegre': '#ff9f43',       // Naranja claro
                        'euf√≥rico': '#feca57',     // Amarillo claro

                        'triste': '#3498db',       // Azul
                        'muy triste': '#2980b9',   // Azul oscuro
                        'deprimido': '#34495e',    // Gris azulado
                        'melanc√≥lico': '#5dade2',  // Azul claro

                        'enojado': '#e74c3c',      // Rojo
                        'furioso': '#c0392b',      // Rojo oscuro
                        'molesto': '#e55039',      // Rojo naranja
                        'irritado': '#ff6b6b',     // Rojo claro

                        'ansioso': '#9b59b6',      // P√∫rpura
                        'nervioso': '#8e44ad',     // P√∫rpura oscuro
                        'estresado': '#a55eea',    // P√∫rpura claro
                        'preocupado': '#74b9ff',   // Azul p√∫rpura
                        'relajado': '#27ae60',     // Verde
                        'calmado': '#2ed573',      // Verde claro
                        'tranquilo': '#1dd1a1',    // Verde agua
                        'sereno': '#55efc4',       // Verde menta

                        'neutral': '#95a5a6',      // Gris
                        'normal': '#bdc3c7',       // Gris claro
                        'bien': '#74b9ff',         // Azul suave
                        'regular': '#a4b0be'       // Gris azulado
                    };

                    // Lista de colores adicionales para emociones nuevas
                    const additionalColors = [
                        '#ff7675', '#fd79a8', '#fdcb6e', '#6c5ce7',
                        '#74b9ff', '#00b894', '#00cec9', '#fd79a8',
                        '#e17055', '#81ecec', '#fab1a0', '#a29bfe',
                        '#ff7675', '#55a3ff', '#26de81', '#fc5c65',
                        '#fed330', '#45aaf2', '#4b7bec', '#26de81'
                    ];

                    return predefinedColors[normalizedMood] ||
                        additionalColors[index % additionalColors.length];
                }
                // Generar colores para cada emoci√≥n
                const backgroundColors = Object.keys(moodCounts).map((normalizedMood, index) => {
                    return generateColor(normalizedMood, index);
                });

                console.log("üé® Colores generados:", backgroundColors);

                //  CREAR GR√ÅFICO DE TORTA
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: moodLabels,
                        datasets: [{
                            label: 'Estados de √Ånimo',
                            data: moodData,
                            backgroundColor: backgroundColors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 10 // Efecto hover
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return `${context.label}: ${context.parsed} d√≠a${context.parsed > 1 ? 's' : ''} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
                // Cambiar el gr√°fico de ejercicio por este c√≥digo corregido:
            } else if (stat.field === 'exercise') {
                console.log("üí™ Procesando gr√°fico de ejercicio:", values);

                // Convertir valores boolean a n√∫meros con direcciones opuestas
                const exerciseValues = values.map(value => {
                    if (value === null || value === undefined) return 0;
                    return value === true ? 1 : -1; //  S√ç=1 (arriba), NO=-1 (abajo)
                });

                // Crear colores din√°micos basados en el valor
                const backgroundColors = exerciseValues.map(value => {
                    if (value === 1) return '#27ae6080'; // Verde para S√ç
                    if (value === -1) return '#e74c3c80'; // Rojo para NO
                    return '#95a5a680'; // Gris para null/0
                });

                //colores para de borde sin trasparencia
                const borderColors = exerciseValues.map(value => {
                    if (value === 1) return '#27ae60'; // Verde para S√ç
                    if (value === -1) return '#e74c3c'; // Rojo para NO
                    return '#95a5a6'; // Gris para null/0
                });

                console.log(`DEBUG: Values ejercicio:`, exerciseValues);
                console.log(`DEBUG: Colores ejercicio:`, backgroundColors);
                console.log('DEBUG: Colores borde:', borderColors);

                //  CREAR EL GR√ÅFICO CON PLUGIN PERSONALIZADO
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: stat.field_display,
                            data: exerciseValues,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: -1.5, // Permitir valores negativos
                                max: 1.5,  // Limitar valores positivos
                                ticks: {
                                    callback: function (value) {
                                        if (value === 1) return '‚úÖ S√ç';
                                        if (value === -1) return '‚ùå NO';
                                        if (value === 0) return '‚Äî';
                                        return '';
                                    },
                                    stepSize: 1
                                },
                                grid: {
                                    display: true,
                                    color: '#ecf0f1', // ‚úÖ L√≠neas suaves para la cuadr√≠cula
                                    lineWidth: 1,
                                    drawOnChartArea: true,
                                    drawTicks: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Ocultar leyenda para mejor visualizaci√≥n
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.parsed.y;
                                        if (value === 1) return 'Ejercicio: ‚úÖ S√ç';
                                        if (value === -1) return 'Ejercicio: ‚ùå NO';
                                        return 'Ejercicio: Sin datos';
                                    }
                                }
                            }
                        }
                    },
                    // ‚úÖ AGREGAR PLUGIN PARA L√çNEA HORIZONTAL EN y=0
                    plugins: [{
                        id: 'horizontalLine',
                        afterDraw: function (chart) {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            const xAxis = chart.scales.x;

                            // Encontrar la posici√≥n y=0
                            const zeroPosition = yAxis.getPixelForValue(0);

                            // Dibujar l√≠nea horizontal negra en y=0
                            ctx.save();
                            ctx.strokeStyle = '#2c3e50'; // Color negro/gris oscuro
                            ctx.lineWidth = 3;           // Grosor de la l√≠nea
                            ctx.setLineDash([]);         // L√≠nea s√≥lida
                            ctx.beginPath();
                            ctx.moveTo(xAxis.left, zeroPosition);
                            ctx.lineTo(xAxis.right, zeroPosition);
                            ctx.stroke();
                            ctx.restore();
                        }
                    }]
                });
                
                <!-- Despu√©s del bloque de ejercicio (l√≠nea ~320), agregar ANTES del `} else {`: -->

} else if (stat.habit_type) {
    // üéØ CONFIGURACI√ìN PARA H√ÅBITOS PERSONALIZADOS
    console.log(`üéØ Procesando h√°bito personalizado: ${stat.field_display}`, stat);
    
    if (stat.habit_type === 'boolean') {
        // H√°bito tipo S√≠/No (como ejercicio)
        const habitValues = values.map(value => {
            if (value === null || value === undefined) return 0;
            return value === true ? 1 : -1; // S√ç=1 (arriba), NO=-1 (abajo)
        });

        const backgroundColors = habitValues.map(value => {
            if (value === 1) return stat.color + '80'; // Color del h√°bito para S√ç
            if (value === -1) return '#e74c3c80'; // Rojo para NO
            return '#95a5a680'; // Gris para null/0
        });

        const borderColors = habitValues.map(value => {
            if (value === 1) return stat.color; // Color del h√°bito para S√ç
            if (value === -1) return '#e74c3c'; // Rojo para NO
            return '#95a5a6'; // Gris para null/0
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: stat.field_display,
                    data: habitValues,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: -1.5,
                        max: 1.5,
                        ticks: {
                            callback: function (value) {
                                if (value === 1) return '‚úÖ S√ç';
                                if (value === -1) return '‚ùå NO';
                                if (value === 0) return '‚Äî';
                                return '';
                            },
                            stepSize: 1
                        },
                        grid: {
                            display: true,
                            color: '#ecf0f1',
                            lineWidth: 1
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = context.parsed.y;
                                if (value === 1) return `${stat.field_display}: ‚úÖ S√ç`;
                                if (value === -1) return `${stat.field_display}: ‚ùå NO`;
                                return `${stat.field_display}: Sin datos`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'horizontalLine',
                afterDraw: function (chart) {
                    const ctx = chart.ctx;
                    const yAxis = chart.scales.y;
                    const xAxis = chart.scales.x;
                    const zeroPosition = yAxis.getPixelForValue(0);

                    ctx.save();
                    ctx.strokeStyle = '#2c3e50';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([]);
                    ctx.beginPath();
                    ctx.moveTo(xAxis.left, zeroPosition);
                    ctx.lineTo(xAxis.right, zeroPosition);
                    ctx.stroke();
                    ctx.restore();
                }
            }]
        });

    } else if (stat.habit_type === 'integer') {
        // H√°bito tipo num√©rico (gr√°fico lineal)
        console.log(`üìä Creando gr√°fico lineal para: ${stat.field_display}`);
        
        // Preparar datasets
        const datasets = [{
            label: stat.field_display + (stat.unit ? ` (${stat.unit})` : ''),
            data: values,
            borderColor: stat.color,
            backgroundColor: stat.color + '20',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: stat.color,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5
        }];

        // Agregar l√≠nea de meta si existe
        if (stat.goal_value) {
            datasets.push({
                label: 'Meta',
                data: Array(labels.length).fill(stat.goal_value),
                borderColor: '#fd7e14',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                tension: 0
            });
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + (stat.unit ? ` ${stat.unit}` : '');
                            }
                        }
                    }
                },
                plugins: {
                    legend: { 
                        display: stat.goal_value ? true : false // Mostrar leyenda solo si hay meta
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                
                                if (context.dataset.label === 'Meta') {
                                    label += context.parsed.y + (stat.unit ? ` ${stat.unit}` : '');
                                } else {
                                    label += context.parsed.y + (stat.unit ? ` ${stat.unit}` : '');
                                    
                                    // Mostrar porcentaje de meta si existe
                                    if (stat.goal_value && context.parsed.y > 0) {
                                        const percentage = ((context.parsed.y / stat.goal_value) * 100).toFixed(1);
                                        label += ` (${percentage}% de la meta)`;
                                    }
                                }
                                
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

} else {
    // ‚úÖ CONFIGURACI√ìN PARA OTROS GR√ÅFICOS (c√≥digo existente sin cambios)
    // ... tu c√≥digo actual para otros gr√°ficos ...

            
                // ‚úÖ CONFIGURACI√ìN PARA OTROS GR√ÅFICOS (BAR/LINE)
                // Limpiar datos null
                values = values.map(value => {
                    if (value === null || value === undefined) return 0;
                    if (stat.type === 'boolean') return value === true ? 1 : 0;
                    return value;
                });

                console.log(`DEBUG: Labels para ${stat.field}:`, labels);
                console.log(`DEBUG: Values para ${stat.field}:`, values);

                new Chart(ctx, {
                    type: stat.chart_type === 'bar' ? 'bar' : 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: stat.field_display,
                            data: values,
                            backgroundColor: stat.color + '80',
                            borderColor: stat.color,
                            borderWidth: 2,
                            fill: stat.chart_type === 'line' ? false : true,
                            tension: stat.chart_type === 'line' ? 0.4 : 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: stat.field === 'exercise' ? 1.2 : undefined,
                                ticks: {
                                    callback: function (value) {
                                        if (stat.field === 'exercise') {
                                            return value === 1 ? 'S√≠' : value === 0 ? 'No' : '';
                                        }
                                        return value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';

                                        if (stat.field === 'exercise') {
                                            label += context.parsed.y === 1 ? 'S√≠' : 'No';
                                        } else if (stat.field === 'water_glasses') {
                                            label += context.parsed.y + ' vasos';
                                        } else if (stat.field === 'sleep_hours') {
                                            label += context.parsed.y + ' horas';
                                        } else {
                                            label += context.parsed.y;
                                        }

                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            console.log(`‚úÖ Gr√°fico creado para ${stat.field_display}`);
        });
    } else {
        console.log("DEBUG: No hay datos para mostrar");
    }
</script>
{% endblock contenido %}